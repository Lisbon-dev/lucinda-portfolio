---
export interface Props {
  type: 'text' | 'email' | 'textarea' | 'select';
  name: string;
  label: string;
  required?: boolean;
  placeholder?: string;
  value?: string;
  options?: Array<{ value: string; label: string; }>;
  rows?: number;
  class?: string;
  id?: string;
  validation?: string;
  'aria-describedby'?: string;
}

const {
  type,
  name,
  label,
  required = false,
  placeholder,
  value = '',
  options = [],
  rows = 4,
  class: className,
  id = `field-${name}`,
  validation,
  'aria-describedby': ariaDescribedBy,
} = Astro.props;

const fieldId = id;
const errorId = `${fieldId}-error`;
const helpId = `${fieldId}-help`;
---

<div class={`form-field ${className || ''}`} data-field-name={name}>
  <div class="form-field__label-container">
    <div 
      id={errorId} 
      class="form-field__error" 
      role="alert" 
      aria-live="polite"
      aria-atomic="true"
    >
      <div class="form-field__error-content"></div>
    </div>
    
    <label for={fieldId} class="form-field__label">
      {label}
      {required && <span class="form-field__required" aria-label="required">*</span>}
    </label>
  </div>
  
  <div class="form-field__input-container">
    {type === 'text' || type === 'email' ? (
      <input
        type={type}
        id={fieldId}
        name={name}
        value={value}
        placeholder={placeholder}
        required={required}
        class="form-field__input focusable"
        aria-describedby={ariaDescribedBy || `${errorId} ${helpId}`.trim()}
        data-validation={validation}
      />
    ) : type === 'textarea' ? (
      <textarea
        id={fieldId}
        name={name}
        placeholder={placeholder}
        required={required}
        rows={rows}
        class="form-field__textarea focusable"
        aria-describedby={ariaDescribedBy || `${errorId} ${helpId}`.trim()}
        data-validation={validation}
      >{value}</textarea>
    ) : type === 'select' ? (
      <select
        id={fieldId}
        name={name}
        required={required}
        class="form-field__select focusable"
        aria-describedby={ariaDescribedBy || `${errorId} ${helpId}`.trim()}
        data-validation={validation}
      >
        <option value="">Choose an option...</option>
        {options.map(option => (
          <option value={option.value} selected={value === option.value}>
            {option.label}
          </option>
        ))}
      </select>
    ) : null}

  </div>

  {validation && (
    <div id={helpId} class="form-field__help">
      <slot name="help" />
    </div>
  )}
</div>

<style>
  .form-field {
    margin-bottom: var(--spacing-md);
  }

  .form-field__label-container {
    position: relative;
    margin-bottom: var(--spacing-xs);
  }

  .form-field__input-container {
    position: relative;
  }

  .form-field__label {
    display: block;
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    font-weight: 400;
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-xs);
    line-height: var(--leading-snug);
  }

  .form-field__required {
    color: #dc2626;
    margin-left: 0.25rem;
  }

  .form-field__input,
  .form-field__textarea,
  .form-field__select {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid rgba(0, 0, 0, 0.2);
    border-radius: 2px;
    font-family: var(--font-body);
    font-size: var(--text-base);
    color: var(--color-text-primary);
    background-color: #ffffff;
    transition: all var(--transition-fast);
    line-height: var(--leading-normal);
  }

  .form-field__input:hover,
  .form-field__textarea:hover,
  .form-field__select:hover {
    border-color: var(--color-primary);
  }

  .form-field__input:focus,
  .form-field__textarea:focus,
  .form-field__select:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    border-color: var(--color-primary);
  }

  .form-field__textarea {
    resize: vertical;
    min-height: 120px;
  }

  .form-field__select {
    cursor: pointer;
  }

  /* Placeholder styling */
  .form-field__input::placeholder,
  .form-field__textarea::placeholder {
    color: rgba(0, 0, 0, 0.5);
    font-style: italic;
  }

  /* Error state */
  .form-field--error .form-field__input,
  .form-field--error .form-field__textarea,
  .form-field--error .form-field__select {
    border-color: var(--color-primary);
    animation: shake 0.5s ease-in-out;
  }

  .form-field--error .form-field__input:focus,
  .form-field--error .form-field__textarea:focus,
  .form-field--error .form-field__select:focus {
    outline: 2px solid transparent;
    outline-offset: 2px;
    border-color: var(--color-primary);
  }

  .form-field__error {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    pointer-events: none;
    display: none;
    margin-bottom: var(--spacing-xs);
  }

  .form-field__error-content {
    background: rgba(50, 92, 89, 0.92);
    color: white;
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: 6px;
    font-size: var(--text-xs);
    line-height: 1.4;
    white-space: nowrap;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    position: relative;
    backdrop-filter: blur(4px);
    max-width: 250px;
  }

  .form-field__error-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-style: solid;
    border-width: 6px 6px 0 6px;
    border-color: rgba(50, 92, 89, 0.92) transparent transparent transparent;
  }

  .form-field--error .form-field__error {
    display: block;
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-2px); }
    75% { transform: translateX(2px); }
  }

  .form-field__help {
    margin-top: var(--spacing-xs);
    font-size: var(--text-sm);
    color: rgba(0, 0, 0, 0.6);
    line-height: var(--leading-normal);
  }

  /* Valid state */
  .form-field--valid .form-field__input,
  .form-field--valid .form-field__textarea,
  .form-field--valid .form-field__select {
    border-color: #16a34a;
    background-color: #f0fdf4;
  }

  /* Disabled state */
  .form-field__input:disabled,
  .form-field__textarea:disabled,
  .form-field__select:disabled {
    background-color: #f5f5f5;
    color: rgba(0, 0, 0, 0.5);
    cursor: not-allowed;
    border-color: rgba(0, 0, 0, 0.1);
  }

  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .form-field__input,
    .form-field__textarea,
    .form-field__select {
      border-width: 2px;
    }

    .form-field--error .form-field__input,
    .form-field--error .form-field__textarea,
    .form-field--error .form-field__select {
      border-width: 3px;
    }
  }

  /* Reduced motion preferences */
  @media (prefers-reduced-motion: reduce) {
    .form-field__input,
    .form-field__textarea,
    .form-field__select {
      transition: none;
    }
  }

  /* Mobile optimizations */
  @media (max-width: var(--breakpoint-sm)) {
    .form-field__input,
    .form-field__textarea,
    .form-field__select {
      font-size: 16px; /* Prevent zoom on iOS */
    }

    .form-field__error-content {
      font-size: 11px;
      white-space: normal;
      max-width: 200px;
    }
  }
</style>
