---
import Layout from "../../layout/Layout.astro";
import BaseSection from "../../components/core/BaseSection.astro";
import Header from "../../components/layout/Header.astro";
import AboutDialog from "../../components/dialog/AboutDialog.astro";
import ContactDialog from "../../components/dialog/ContactDialog.astro";
import OptimizedVideo from "../../components/ui/OptimizedVideo.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  // Sort projects to ensure previous/next navigation is in the correct order
  const sortedProjects = projects.sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    if (orderA !== orderB) return orderA - orderB;
    return (
      new Date(b.data.publishedDate).getTime() -
      new Date(a.data.publishedDate).getTime()
    );
  });

  return sortedProjects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

interface Props {
  project: CollectionEntry<"projects">;
}

const { project } = Astro.props;

// Generate SEO data for this project
const projectSEO = {
  title:
    project.data.seo?.title ||
    `${project.data.title} - ${project.data.category} by Lucinda Burman`,
  description:
    project.data.seo?.description ||
    `${project.data.description} ${project.data.category} project by Lucinda Burman, featuring ${project.data.tags?.join(", ") || "creative design"}.`,
  keywords:
    project.data.seo?.keywords ||
    [
      ...(project.data.tags || []),
      project.data.category,
      "editorial illustration",
      "creative design",
      project.data.client
        ? `${project.data.client} project`
        : "portfolio project",
    ].filter(Boolean),
  type: "article" as const,
  image:
    project.data.seo?.ogImage ||
    project.data.mainImage.src.src ||
    project.data.mainImage.src,
  noindex: project.data.seo?.noindex || false,
};

// Get all projects for navigation carousel
const allProjects = (await getCollection("projects")).sort((a, b) => {
  const orderA = a.data.order ?? 999;
  const orderB = b.data.order ?? 999;
  if (orderA !== orderB) return orderA - orderB;
  return (
    new Date(b.data.publishedDate).getTime() -
    new Date(a.data.publishedDate).getTime()
  );
});
const currentIndex = allProjects.findIndex((p) => p.slug === project.slug);
const previousProject =
  currentIndex > 0
    ? allProjects[currentIndex - 1]
    : allProjects[allProjects.length - 1];
const nextProject =
  currentIndex < allProjects.length - 1
    ? allProjects[currentIndex + 1]
    : allProjects[0];

const previousProjectUrl = `/projects/${previousProject.slug}`;
const nextProjectUrl = `/projects/${nextProject.slug}`;

// Logic for pagination dots
const totalProjects = allProjects.length;
const maxDots = 5;
const numDots = Math.min(totalProjects, maxDots);

let dotsStartIndex = 0;
if (totalProjects > maxDots) {
  dotsStartIndex = Math.max(0, currentIndex - Math.floor(maxDots / 2));
  dotsStartIndex = Math.min(dotsStartIndex, totalProjects - maxDots);
}

const projectsForDots = allProjects.slice(
  dotsStartIndex,
  dotsStartIndex + numDots
);
const activeDotIndex = currentIndex - dotsStartIndex;
---

<Layout seo={projectSEO}>
  <!-- Reuse Header Component -->
  <Header />

  <!-- Main Project Content -->
  <main class="project-page" id="top">
    <!-- Desktop Navigation Arrows -->
    <a
      href={previousProjectUrl}
      class="desktop-nav-arrow desktop-nav-arrow--prev"
      aria-label={`Previous project: ${previousProject.data.title}`}
      data-astro-prefetch
    >
      <svg
        width="32"
        height="32"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M15 18L9 12L15 6"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </a>
    <a
      href={nextProjectUrl}
      class="desktop-nav-arrow desktop-nav-arrow--next"
      aria-label={`Next project: ${nextProject.data.title}`}
      data-astro-prefetch
    >
      <svg
        width="32"
        height="32"
        viewBox="0 0 24 24"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M9 18L15 12L9 6"
          stroke="currentColor"
          stroke-width="1.5"
          stroke-linecap="round"
          stroke-linejoin="round"></path>
      </svg>
    </a>
    <!-- Hero Section - Match landing page exactly -->
    <BaseSection variant="hero" fullHeight={false} backgroundColor="background">
      <div class="hero-container">
        <header class="project-hero">
          <a href="/" class="home-link" aria-label="Go to homepage">
            <h1 class="project-site-title">LUCINDA BURMAN</h1>
          </a>
          <h2 class="project-category">{project.data.category}</h2>
        </header>
      </div>
    </BaseSection>

    <!-- Project Content Section -->
    <div class="project-content-section">
      <div class="project-content-container">
        <!-- Project Description with Navigation -->
        <div class="description-with-navigation">
          <div class="navigation">
            <a
              href={previousProjectUrl}
              class="touch-nav-arrow touch-nav-arrow--prev"
              aria-label={`Previous project: ${previousProject.data.title}`}
              data-astro-prefetch
            >
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M15 18L9 12L15 6"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
            </a>
            <a
              href={nextProjectUrl}
              class="touch-nav-arrow touch-nav-arrow--next"
              aria-label={`Next project: ${nextProject.data.title}`}
              data-astro-prefetch
            >
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9 18L15 12L9 6"
                  stroke="currentColor"
                  stroke-width="1.5"
                  stroke-linecap="round"
                  stroke-linejoin="round"></path>
              </svg>
            </a>
          </div>
          <div class="project-description">
            <h2 class="project-title">{project.data.title}</h2>
            <p class="project-description-text">{project.data.description}</p>
          </div>
        </div>

        <!-- Single Column Image Display -->
        <div class="project-images">
          <!-- Main Image -->
          <div class="image-wrapper">
            <Image
              src={project.data.mainImage.src}
              alt={project.data.mainImage.alt}
              class="project-image"
              width={695}
              height={project.data.mainImage.height || 600}
              format="webp"
              quality={85}
              loading="eager"
              fetchpriority="high"
              densities={[1, 1.5, 2]}
            />
          </div>

          <!-- Additional Images and Videos -->
          {
            (() => {
              // Combine images and videos with their positions
              const mediaItems = [];

              // Add additional images
              if (project.data.images) {
                project.data.images.forEach((image, index) => {
                  mediaItems.push({
                    type: "image",
                    data: image,
                    position: index + 1,
                  });
                });
              }

              // Add videos at their specified positions
              if (project.data.videos) {
                project.data.videos.forEach((video) => {
                  mediaItems.push({
                    type: "video",
                    data: video,
                    position: video.position ?? mediaItems.length + 1,
                  });
                });
              }

              // Sort by position
              mediaItems.sort((a, b) => a.position - b.position);

              // Render sorted media items
              return mediaItems.map((item, index) => {
                if (item.type === "video") {
                  return (
                    <div class="video-wrapper">
                      <OptimizedVideo
                        src={item.data.src}
                        poster={item.data.poster?.src}
                        alt={item.data.alt}
                        width={item.data.width || 695}
                        height={item.data.height || 600}
                        class="project-video"
                      />
                    </div>
                  );
                } else {
                  return (
                    <div class="image-wrapper">
                      <Image
                        src={item.data.src}
                        alt={item.data.alt}
                        class="project-image"
                        width={695}
                        height={item.data.height || 600}
                        format="webp"
                        quality={85}
                        loading={index < 2 ? "eager" : "lazy"}
                        fetchpriority={index < 1 ? "high" : "low"}
                        densities={[1, 1.5, 2]}
                      />
                    </div>
                  );
                }
              });
            })()
          }
        </div>
        <div class="navigation">
          <a
            href={previousProjectUrl}
            class="touch-nav-arrow touch-nav-arrow--prev"
            aria-label={`Previous project: ${previousProject.data.title}`}
            data-astro-prefetch
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M15 18L9 12L15 6"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
          </a>
          <a
            href={nextProjectUrl}
            class="touch-nav-arrow touch-nav-arrow--next"
            aria-label={`Next project: ${nextProject.data.title}`}
            data-astro-prefetch
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M9 18L15 12L9 6"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"></path>
            </svg>
          </a>
        </div>
        <!-- Back to Top Link -->
        <div class="back-to-top">
          <a href="#top" class="back-to-top-link">BACK TO TOP</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Project Counter for mobile -->
  <div class="project-counter" aria-hidden="true">
    <span>{currentIndex + 1} / {totalProjects}</span>
  </div>

  <!-- Dialog Modals -->
  <AboutDialog />
  <ContactDialog />
</Layout>

<script>
  import Lenis from "lenis";

  // Initialize Lenis with optimized settings
  const lenis = new Lenis({
    lerp: 0.08,
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    orientation: "vertical",
    gestureOrientation: "vertical",
    smoothWheel: true,
    wheelMultiplier: 1,
    touchMultiplier: 1,
    autoResize: true,
  });

  // Coordinated RAF loop for Lenis
  function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }
  requestAnimationFrame(raf);

  document.addEventListener("DOMContentLoaded", () => {
    const backToTopLink = document.querySelector(".back-to-top-link");
    backToTopLink?.addEventListener("click", (event) => {
      event.preventDefault();
      try {
        // Use the locally initialized lenis instance
        lenis?.scrollTo("#top");
      } catch (error) {
        console.warn("Smooth scroll failed, using fallback:", error);
        // Fallback to native scroll
        document.getElementById("top")?.scrollIntoView({ behavior: "smooth" });
      }
    });
  });
</script>

<style>
  /* ============================================
     CLIENT DESIGN SPECIFICATIONS
     Base viewport: 1512px × 982px (MacBook)
     All measurements derived from wireframe
     
     Breakpoint Strategy:
     - Mobile: max-width 480px → 70% scale, 5vw padding
     - Tablet Portrait: 481px - 768px → 80% scale, mobile padding
     - Desktop: 769px - 1511px → 100% scale, 27.12% padding (design system)
     - Client Viewport: 1512px+ → 100% scale, 410px fixed padding
     ============================================ */
  :root {
    /* Container System - Based on 410px margins at 1512px */
    --project-container-margin-ratio: 27.12%; /* 410px / 1512px - maintains proportion */
    --project-container-margin-fixed: 410px; /* Locks at 1512px+ */
    --project-container-max-width: 1512px;

    /* Content Spacing - Wireframe measurements */
    --project-content-gap: 66px; /* Image spacing from wireframe */
    --project-hero-to-content: 79px; /* 397px total - 318px hero */
    --project-hero-padding-top: max(11.2vh, 110px); /* 110px / 982px */

    /* Navigation Arrow Positioning */
    --nav-arrow-inset-desktop: 5vw; /* Distance from viewport edge */
    --nav-arrow-size: 32px;
    --nav-arrow-size-mobile: 24px;

    /* Responsive Scale Factors */
    --scale-tablet: 0.8; /* 481px - 768px */
    --scale-mobile: 0.7; /* max-width 480px */
  }

  /* ============================================
     BASE LAYOUT
     ============================================ */
  .project-page {
    position: relative;
  }

  /* ============================================
     HERO SECTION
     Measurements from client wireframe
     ============================================ */
  .project-hero {
    text-align: center;
    padding-block-start: var(--project-hero-padding-top);

    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    gap: var(--spacing-md);
  }

  .home-link {
    text-decoration: none;
    color: inherit;
    transition: opacity var(--transition-normal);
  }

  .home-link:hover {
    opacity: 0.8;
  }

  .project-site-title {
    font-family: var(--font-heading);
    font-size: var(--text-hero-header);
    font-weight: 400;
    line-height: var(--leading-tight);
    letter-spacing: var(--tracking-wider);
    color: var(--color-text-primary);
    margin: 0;
  }

  .project-category {
    font-family: var(--font-heading);
    font-size: var(--text-sub-header);
    font-weight: 100;
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-wide);
    color: var(--color-text-primary);
    opacity: 0.8;
    margin: 0;
  }

  /* ============================================
     CONTENT SECTION
     79px spacing from wireframe (397px - 318px)
     ============================================ */
  .project-content-section {
    padding-block-start: var(--project-hero-to-content);
    background-color: var(--color-background);
  }

  .hero-container {
    max-width: var(--project-container-max-width);
    margin: 0 auto;
    padding: 0 var(--spacing-container-desktop);
  }

  .project-content-container {
    max-width: var(--project-container-max-width);
    margin-inline: auto;
    /* Use 27.12% until 1512px, then lock to 410px */
    padding-inline: min(
      var(--project-container-margin-ratio),
      var(--project-container-margin-fixed)
    );
    position: relative;
  }

  /* ============================================
     PROJECT DESCRIPTION
     ============================================ */
  .description-with-navigation {
    position: relative;
    display: flex;
    justify-content: space-between;
    align-items: start;
    flex-direction: column;
    margin-block-end: var(--project-content-gap);
  }

  .navigation {
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding-top: var(--spacing-lg);
  }

  .project-description {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: var(--spacing-sm);
    text-align: start;
    padding: 0 var(--spacing-xxs);
    flex-grow: 1;
  }

  .project-title {
    font-family: var(--font-heading);
    font-size: var(--text-sub-header);
    font-weight: 100;
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-wider);
    color: var(--color-text-primary);
    margin: 0;
  }

  .project-description-text {
    font-family: var(--font-sub-heading);
    font-size: var(--text-sm);
    font-weight: 300;
    line-height: var(--leading-tight);
    letter-spacing: var(--tracking-wide);
    color: var(--color-text-primary);
    margin: 0;
  }

  /* ============================================
     TOUCH NAVIGATION ARROWS
     ============================================ */
  .touch-nav-arrow {
    display: none; /* Hidden by default, shown on mobile */
    color: var(--color-text-secondary);
    text-decoration: none;
    opacity: 0.7;
    transition:
      opacity var(--transition-normal),
      color var(--transition-normal);
    padding: var(--spacing-sm); /* Larger tap area */
    margin: calc(-1 * var(--spacing-sm)); /* Negative margin to keep layout */
  }

  .touch-nav-arrow:hover {
    opacity: 1;
    color: var(--color-text-primary);
  }

  .touch-nav-arrow--prev {
    margin-right: var(--spacing-md);
  }

  .touch-nav-arrow--next {
    margin-left: var(--spacing-md);
  }

  /* ============================================
     DESKTOP NAVIGATION ARROWS
     ============================================ */
  .desktop-nav-arrow {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    color: var(--color-text-secondary);
    text-decoration: none;
    opacity: 0.7;
    transition:
      opacity var(--transition-normal),
      color var(--transition-normal);
    display: none; /* Hidden on mobile by default */
  }

  .desktop-nav-arrow:hover {
    opacity: 1;
    color: var(--color-text-primary);
  }

  .desktop-nav-arrow--prev {
    left: var(--nav-arrow-inset-desktop);
  }

  .desktop-nav-arrow--next {
    right: var(--nav-arrow-inset-desktop);
  }

  /* ============================================
     MEDIA GRID
     66px gaps from wireframe
     ============================================ */
  .project-images {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .image-wrapper,
  .video-wrapper {
    width: 100%;
  }

  .image-wrapper:not(:last-child),
  .video-wrapper:not(:last-child) {
    margin-block-end: var(--project-content-gap);
  }

  .project-image,
  .project-video {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 0;
  }

  /* ============================================
     PROJECT COUNTER
     ============================================ */
  .project-counter {
    display: none; /* Hidden by default, shown on mobile */
    text-align: center;
    color: var(--color-text-secondary);
    font-family: var(--font-body);
    font-size: var(--text-sm);
    letter-spacing: var(--tracking-wide);
    padding-block-end: var(--spacing-lg);
    user-select: none;
    -webkit-user-select: none;
  }

  /* ============================================
     BACK TO TOP
     ============================================ */
  .back-to-top {
    text-align: center;
    margin-block-start: var(--project-content-gap);
    padding-block-end: var(--spacing-xl);
  }

  .back-to-top-link {
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-normal);
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
  }

  .back-to-top-link:hover,
  .back-to-top-link:focus-visible {
    color: var(--color-text-primary);
  }

  .back-to-top-link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 4px;
    border-radius: var(--rounded-sm);
  }

  /* ============================================
     RESPONSIVE: DESKTOP (769px - 1511px)
     Maintains 27.12% padding per design system
     ============================================ */
  @media (min-width: 769px) and (max-width: 1511px) {
    .hero-container {
      padding: 0 var(--spacing-container-desktop);
    }

    /* project-content-container inherits base 27.12% padding */
    /* No override needed - respects design system */

    /* Desktop view does not have touch arrows or swipe hints */
  }

  /* ============================================
     RESPONSIVE: CLIENT VIEWPORT (1512px)
     Exact design specifications
     ============================================ */
  @media (min-width: 1512px) {
    .project-content-container {
      padding-inline: var(--project-container-margin-fixed);
    }

    .hero-container {
      padding: 0 var(--spacing-container-desktop);
    }

    /* Large desktop view does not have touch arrows */
  }

  /* ============================================
     RESPONSIVE: TABLET PORTRAIT (481px - 768px)
     80% scale factor
     ============================================ */
  @media (min-width: 481px) and (max-width: 768px) {
    .project-content-section {
      padding-block-start: calc(
        var(--project-hero-to-content) * var(--scale-tablet)
      );
    }

    .hero-container,
    .project-content-container {
      padding-inline: var(--spacing-container-mobile);
    }

    .image-wrapper:not(:last-child),
    .video-wrapper:not(:last-child),
    .description-with-navigation {
      margin-block-end: calc(var(--project-content-gap) * var(--scale-tablet));
    }

    .back-to-top {
      margin-block-start: calc(
        var(--project-content-gap) * var(--scale-tablet)
      );
    }

    .nav-arrow svg {
      width: var(--nav-arrow-size-mobile);
      height: var(--nav-arrow-size-mobile);
    }
  }

  /* ============================================
     RESPONSIVE: MOBILE (max-width: 480px)
     70% scale factor
     ============================================ */
  @media (max-width: 480px) {
    .project-content-section {
      padding-block-start: calc(
        var(--project-hero-to-content) * var(--scale-mobile)
      );
    }

    .hero-container,
    .project-content-container {
      padding-inline: 5vw;
    }

    .image-wrapper:not(:last-child),
    .video-wrapper:not(:last-child),
    .description-with-navigation {
      margin-block-end: calc(var(--project-content-gap) * var(--scale-mobile));
    }

    .back-to-top {
      margin-block-start: calc(
        var(--project-content-gap) * var(--scale-mobile)
      );
    }

    .project-description {
      padding: 0 var(--spacing-sm);
    }
  }

  /* ============================================
     RESPONSIVE: HIDE/SHOW NAVIGATION
     ============================================ */
  @media (max-width: 1023px) {
    .description-with-navigation {
      gap: var(--space-lg);
    }
    .touch-nav-arrow {
      display: block;
    }
    .project-counter {
      display: block;
    }

    .project-content-section {
      padding-block-start: unset;
    }
  }

  @media (min-width: 1024px) {
    .desktop-nav-arrow {
      display: block;
    }
  }

  /* ============================================
     ACCESSIBILITY
     ============================================ */
  @media (prefers-reduced-motion: reduce) {
    .desktop-nav-arrow,
    .touch-nav-arrow,
    .home-link {
      transition: none;
    }
  }

  @media (prefers-contrast: high) {
    .desktop-nav-arrow,
    .touch-nav-arrow {
      border: 2px solid transparent; /* Reserve space */
      color: ButtonText;
    }
    .desktop-nav-arrow:focus-visible,
    .touch-nav-arrow:focus-visible {
      border-color: ButtonText;
    }
  }
</style>
