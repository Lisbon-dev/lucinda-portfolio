---
import Layout from "../../layout/Layout.astro";
import BaseSection from "../../components/core/BaseSection.astro";
import Header from "../../components/layout/Header.astro";
import AboutDialog from "../../components/dialog/AboutDialog.astro";
import ContactDialog from "../../components/dialog/ContactDialog.astro";
import OptimizedVideo from "../../components/ui/OptimizedVideo.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  // Sort projects to ensure previous/next navigation is in the correct order
  const sortedProjects = projects.sort((a, b) => {
    const orderA = a.data.order ?? 999;
    const orderB = b.data.order ?? 999;
    if (orderA !== orderB) return orderA - orderB;
    return new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime();
  });

  return sortedProjects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

interface Props {
  project: CollectionEntry<"projects">;
}

const { project } = Astro.props;

// Generate SEO data for this project
const projectSEO = {
  title: project.data.seo?.title || `${project.data.title} - ${project.data.category} by Lucinda Burman`,
  description: project.data.seo?.description || `${project.data.description} ${project.data.category} project by Lucinda Burman, featuring ${project.data.tags?.join(", ") || "creative design"}.`,
  keywords: project.data.seo?.keywords || [
    ...project.data.tags || [],
    project.data.category,
    "editorial illustration",
    "creative design",
    project.data.client ? `${project.data.client} project` : "portfolio project"
  ].filter(Boolean),
  type: "article" as const,
  image: project.data.seo?.ogImage || project.data.mainImage.src.src || project.data.mainImage.src,
  noindex: project.data.seo?.noindex || false
};

// Get all projects for navigation carousel
const allProjects = (await getCollection("projects")).sort((a, b) => {
  const orderA = a.data.order ?? 999;
  const orderB = b.data.order ?? 999;
  if (orderA !== orderB) return orderA - orderB;
  return new Date(b.data.publishedDate).getTime() - new Date(a.data.publishedDate).getTime();
});
const currentIndex = allProjects.findIndex((p) => p.slug === project.slug);
const previousProject =
  currentIndex > 0
    ? allProjects[currentIndex - 1]
    : allProjects[allProjects.length - 1];
const nextProject =
  currentIndex < allProjects.length - 1
    ? allProjects[currentIndex + 1]
    : allProjects[0];

const previousProjectUrl = `/projects/${previousProject.slug}`;
const nextProjectUrl = `/projects/${nextProject.slug}`;

// Logic for pagination dots
const totalProjects = allProjects.length;
const maxDots = 5;
const numDots = Math.min(totalProjects, maxDots);

let dotsStartIndex = 0;
if (totalProjects > maxDots) {
  dotsStartIndex = Math.max(0, currentIndex - Math.floor(maxDots / 2));
  dotsStartIndex = Math.min(dotsStartIndex, totalProjects - maxDots);
}

const projectsForDots = allProjects.slice(
  dotsStartIndex,
  dotsStartIndex + numDots,
);
const activeDotIndex = currentIndex - dotsStartIndex;
---

<Layout seo={projectSEO}>
  <!-- Reuse Header Component -->
  <Header />

  <!-- Main Project Content -->
  <main
    class="project-page"
    id="top"
    data-prev-url={previousProjectUrl}
    data-next-url={nextProjectUrl}
  >
    <!-- Navigation Arrows positioned beside description -->
    <nav class="project-navigation" aria-label="Project navigation">
      <a
        href={previousProjectUrl}
        class="nav-arrow nav-arrow--prev"
        aria-label={`Previous project: ${previousProject.data.title}`}
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M15 18L9 12L15 6"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </a>
      <a
        href={nextProjectUrl}
        class="nav-arrow nav-arrow--next"
        aria-label={`Next project: ${nextProject.data.title}`}
      >
        <svg
          width="24"
          height="24"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M9 18L15 12L9 6"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"></path>
        </svg>
      </a>
    </nav>

    <!-- Hero Section - Match landing page exactly -->
    <BaseSection
      variant="hero"
      fullHeight={false}
      backgroundColor="background"
    >
      <div class="hero-container">
        <header class="project-hero">
          <a href="/" class="home-link" aria-label="Go to homepage">
            <h1 class="project-site-title">LUCINDA BURMAN</h1>
          </a>
          <h2 class="project-category">{project.data.category}</h2>
        </header>
      </div>
    </BaseSection>

    <!-- Project Content Section -->
    <div class="project-content-section">
      <div class="project-content-container">
        <!-- Project Description with Navigation -->
        <div class="description-with-navigation">
          <div class="project-description">
            <h2 class="project-title">{project.data.title}</h2>
            <p class="project-description-text">{project.data.description}</p>
          </div>
        </div>

        <!-- Single Column Image Display -->
        <div class="project-images">
          <!-- Main Image -->
          <div class="image-wrapper">
            <Image
              src={project.data.mainImage.src}
              alt={project.data.mainImage.alt}
              class="project-image"
              width={695}
              height={project.data.mainImage.height || 600}
              format="webp"
              quality={85}
              loading="eager"
              fetchpriority="high"
              densities={[1, 1.5, 2]}
            />
          </div>

          <!-- Additional Images and Videos -->
          {
            (() => {
              // Combine images and videos with their positions
              const mediaItems = [];
              
              // Add additional images
              if (project.data.images) {
                project.data.images.forEach((image, index) => {
                  mediaItems.push({
                    type: 'image',
                    data: image,
                    position: index + 1
                  });
                });
              }
              
              // Add videos at their specified positions
              if (project.data.videos) {
                project.data.videos.forEach((video) => {
                  mediaItems.push({
                    type: 'video',
                    data: video,
                    position: video.position ?? mediaItems.length + 1
                  });
                });
              }
              
              // Sort by position
              mediaItems.sort((a, b) => a.position - b.position);
              
              // Render sorted media items
              return mediaItems.map((item, index) => {
                if (item.type === 'video') {
                  return (
                    <div class="video-wrapper">
                      <OptimizedVideo
                        src={item.data.src}
                        poster={item.data.poster?.src}
                        alt={item.data.alt}
                        width={item.data.width || 695}
                        height={item.data.height || 600}
                        class="project-video"
                      />
                    </div>
                  );
                } else {
                  return (
                    <div class="image-wrapper">
                      <Image
                        src={item.data.src}
                        alt={item.data.alt}
                        class="project-image"
                        width={695}
                        height={item.data.height || 600}
                        format="webp"
                        quality={85}
                        loading={index < 2 ? "eager" : "lazy"}
                        fetchpriority={index < 1 ? "high" : "low"}
                        densities={[1, 1.5, 2]}
                      />
                    </div>
                  );
                }
              });
            })()
          }
        </div>

        <!-- Back to Top Link -->
        <div class="back-to-top">
          <a href="#top" class="back-to-top-link">BACK TO TOP</a>
        </div>
      </div>
    </div>
  </main>

  <!-- Mobile Swipe Hint -->
  <div class="mobile-swipe-hint" aria-hidden="true">
    <div class="swipe-dots">
      {
        projectsForDots.map((_p, index) => (
          <span class:list={["swipe-dot", { active: index === activeDotIndex }]} />
        ))
      }
    </div>
  </div>

  <!-- Dialog Modals -->
  <AboutDialog />
  <ContactDialog />
</Layout>

<script>
  import Lenis from "lenis";

  // Initialize Lenis with optimized settings
  const lenis = new Lenis({
    lerp: 0.08,
    duration: 1.2,
    easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
    orientation: "vertical",
    gestureOrientation: "vertical",
    smoothWheel: true,
    wheelMultiplier: 1,
    touchMultiplier: 1,
    autoResize: true,
  });

  // Coordinated RAF loop for Lenis
  function raf(time) {
    lenis.raf(time);
    requestAnimationFrame(raf);
  }
  requestAnimationFrame(raf);

  document.addEventListener("DOMContentLoaded", () => {
    const projectPage = document.querySelector(".project-page");
    if (!projectPage) return;

    const prevUrl = projectPage.dataset.prevUrl;
    const nextUrl = projectPage.dataset.nextUrl;

    if (!prevUrl || !nextUrl) return;

    // Enhanced swipe detection with zoom protection
    let touchStartX = 0;
    let touchEndX = 0;
    let touchStartY = 0;
    let touchEndY = 0;
    let touchStartTime = 0;
    let initialTouchCount = 0;
    let maxTouchCount = 0;
    let isPinching = false;
    let lastPinchTime = 0;
    
    // Configuration
    const config = {
      swipeThreshold: 40,           // Minimum distance (px)
      velocityThreshold: 0.3,       // Minimum speed (px/ms)
      maxVerticalRatio: 0.5,        // Max vertical/horizontal movement ratio
      maxDuration: 750,             // Maximum swipe duration (ms)
      pinchCooldown: 300,           // Time after pinch before allowing swipe (ms)
    };

    projectPage.addEventListener("touchstart", (event) => {
      const touchCount = event.touches.length;
      initialTouchCount = touchCount;
      maxTouchCount = touchCount;
      
      // Check if touch started on media element (allow zoom on media)
      const target = event.target;
      const isMediaElement = 
        target instanceof HTMLImageElement ||
        target instanceof HTMLVideoElement ||
        target.closest('.image-wrapper') !== null ||
        target.closest('.video-wrapper') !== null;
      
      if (isMediaElement) {
        touchStartX = 0;
        return;
      }
      
      // Reset pinch flag on new single-touch gesture
      if (touchCount === 1) {
        isPinching = false;
        touchStartX = event.touches[0].clientX;
        touchStartY = event.touches[0].clientY;
        touchStartTime = Date.now();
      } else {
        // Multi-touch detected - this is a pinch/zoom gesture
        isPinching = true;
        lastPinchTime = Date.now();
        touchStartX = 0;
        touchStartY = 0;
      }
    }, { passive: true });

    projectPage.addEventListener("touchmove", (event) => {
      const touchCount = event.touches.length;
      
      // Track maximum touch count during gesture
      if (touchCount > maxTouchCount) {
        maxTouchCount = touchCount;
      }
      
      // If we ever had multiple touches, mark as pinch
      if (touchCount > 1 || maxTouchCount > 1) {
        isPinching = true;
        lastPinchTime = Date.now();
      }
    }, { passive: true });

    projectPage.addEventListener("touchend", (event) => {
      // Ignore if there are still touches on screen
      if (event.touches.length > 0) {
        return;
      }
      
      const timeSincePinch = Date.now() - lastPinchTime;
      
      // Reject swipe if:
      // - We detected a pinch during this gesture
      // - We're in cooldown period after a pinch
      // - Initial touch wasn't single-finger
      // - We ever had multiple touches
      // - Touch start wasn't recorded
      if (
        isPinching ||
        timeSincePinch < config.pinchCooldown ||
        initialTouchCount !== 1 ||
        maxTouchCount > 1 ||
        touchStartX === 0
      ) {
        // Reset state
        touchStartX = 0;
        touchStartY = 0;
        initialTouchCount = 0;
        maxTouchCount = 0;
        return;
      }

      touchEndX = event.changedTouches[0].clientX;
      touchEndY = event.changedTouches[0].clientY;
      
      handleSwipe();
      
      // Reset state
      touchStartX = 0;
      touchStartY = 0;
      initialTouchCount = 0;
      maxTouchCount = 0;
    }, { passive: true });

    function handleSwipe() {
      const deltaX = touchEndX - touchStartX;
      const deltaY = touchEndY - touchStartY;
      const deltaTime = Date.now() - touchStartTime;
      
      const absX = Math.abs(deltaX);
      const absY = Math.abs(deltaY);
      
      // Calculate velocity (px/ms)
      const velocity = absX / deltaTime;
      
      // Validation checks
      const isHorizontal = absX > absY;
      const meetsDistanceThreshold = absX >= config.swipeThreshold;
      const meetsVelocityThreshold = velocity >= config.velocityThreshold;
      const verticalRatio = absY / (absX || 1);
      const isNotTooVertical = verticalRatio <= config.maxVerticalRatio;
      const isNotTooSlow = deltaTime <= config.maxDuration;
      
      // All conditions must be met
      if (
        !isHorizontal ||
        !meetsDistanceThreshold ||
        !meetsVelocityThreshold ||
        !isNotTooVertical ||
        !isNotTooSlow
      ) {
        return;
      }
      
      // Navigate
      if (deltaX < 0) {
        // Swiped left -> Next project
        window.location.href = nextUrl;
      } else {
        // Swiped right -> Previous project
        window.location.href = prevUrl;
      }
    }

    const backToTopLink = document.querySelector(".back-to-top-link");
    backToTopLink?.addEventListener("click", (event) => {
      event.preventDefault();
      // Use the locally initialized lenis instance
      lenis?.scrollTo("#top");
    });
  });
</script>

<style>
  /* ============================================
     CLIENT DESIGN SPECIFICATIONS
     Base viewport: 1512px × 982px (MacBook)
     All measurements derived from wireframe
     
     Breakpoint Strategy:
     - Mobile: max-width 480px → 70% scale, 5vw padding
     - Tablet Portrait: 481px - 768px → 80% scale, mobile padding
     - Desktop: 769px - 1511px → 100% scale, 27.12% padding (design system)
     - Client Viewport: 1512px+ → 100% scale, 410px fixed padding
     ============================================ */
  :root {
    /* Container System - Based on 410px margins at 1512px */
    --project-container-margin-ratio: 27.12%; /* 410px / 1512px - maintains proportion */
    --project-container-margin-fixed: 410px; /* Locks at 1512px+ */
    --project-container-max-width: 1512px;
    
    /* Content Spacing - Wireframe measurements */
    --project-content-gap: 66px; /* Image spacing from wireframe */
    --project-hero-to-content: 79px; /* 397px total - 318px hero */
    --project-hero-padding-top: max(11.2vh, 110px); /* 110px / 982px */
    
    /* Navigation Arrow Positioning */
    --nav-arrow-inset-base: -15vw; /* Distance from container edge */
    --nav-arrow-size: 32px;
    --nav-arrow-size-mobile: 24px;
    
    /* Responsive Scale Factors */
    --scale-tablet: 0.8; /* 481px - 768px */
    --scale-mobile: 0.7; /* max-width 480px */
  }

  /* ============================================
     BASE LAYOUT
     ============================================ */
  .project-page {
    position: relative;
  }

  /* ============================================
     HERO SECTION
     Measurements from client wireframe
     ============================================ */
  .project-hero {
    text-align: center;
    padding-block-start: var(--project-hero-padding-top);
    
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: center;
    gap: var(--spacing-md);
  }

  .home-link {
    text-decoration: none;
    color: inherit;
    transition: opacity var(--transition-normal);
  }

  .home-link:hover {
    opacity: 0.8;
  }

  .project-site-title {
    font-family: var(--font-heading);
    font-size: var(--text-hero-header);
    font-weight: 400;
    line-height: var(--leading-tight);
    letter-spacing: var(--tracking-wider);
    color: var(--color-text-primary);
    margin: 0;
  }

  .project-category {
    font-family: var(--font-heading);
    font-size: var(--text-sub-header);
    font-weight: 100;
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-wide);
    color: var(--color-text-primary);
    opacity: 0.8;
    margin: 0;
  }

  /* ============================================
     CONTENT SECTION
     79px spacing from wireframe (397px - 318px)
     ============================================ */
  .project-content-section {
    padding-block-start: var(--project-hero-to-content);
    background-color: var(--color-background);
  }

  .hero-container {
    max-width: var(--project-container-max-width);
    margin: 0 auto;
    padding: 0 var(--spacing-container-desktop);
  }

  .project-content-container {
    max-width: var(--project-container-max-width);
    margin-inline: auto;
    /* Use 27.12% until 1512px, then lock to 410px */
    padding-inline: min(
      var(--project-container-margin-ratio),
      var(--project-container-margin-fixed)
    );
    position: relative;
  }

  /* ============================================
     PROJECT DESCRIPTION
     ============================================ */
  .description-with-navigation {
    position: relative;
    display: flex;
    justify-content: flex-start;
    align-items: flex-start;
    margin-block-end: var(--project-content-gap);
  }

  .project-description {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    gap: var(--spacing-sm);
    text-align: start;
    padding: 0 var(--spacing-xxs);
  }

  .project-title {
    font-family: var(--font-heading);
    font-size: var(--text-sub-header);
    font-weight: 100;
    line-height: var(--leading-snug);
    letter-spacing: var(--tracking-wider);
    color: var(--color-text-primary);
    margin: 0;
  }

  .project-description-text {
    font-family: var(--font-sub-heading);
    font-size: var(--text-xs);
    font-weight: 300;
    line-height: var(--leading-tight);
    letter-spacing: var(--tracking-wide);
    color: var(--color-text-primary);
    margin: 0;
  }

  /* ============================================
     NAVIGATION ARROWS
     Positioned within margin area (27.12% or 410px)
     ============================================ */
  .project-navigation {
    /* Semantic wrapper only */
  }
  
  .nav-arrow {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    
    display: flex;
    align-items: center;
    justify-content: center;
    
    inline-size: var(--nav-arrow-size);
    block-size: var(--nav-arrow-size);
    
    color: var(--color-text-secondary);
    text-decoration: none;
    opacity: 0.7;
    transition: opacity var(--transition-normal), color var(--transition-normal);
  }

  .nav-arrow:hover {
    opacity: 1;
    color: var(--color-text-primary);
  }

  .nav-arrow svg {
    width: var(--nav-arrow-size);
    height: var(--nav-arrow-size);
  }

  /* ============================================
     MEDIA GRID
     66px gaps from wireframe
     ============================================ */
  .project-images {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .image-wrapper,
  .video-wrapper {
    width: 100%;
  }

  .image-wrapper:not(:last-child),
  .video-wrapper:not(:last-child) {
    margin-block-end: var(--project-content-gap);
  }

  .project-image,
  .project-video {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 0;
  }

  /* ============================================
     MOBILE SWIPE UI
     ============================================ */
  .mobile-swipe-hint {
    display: flex;
    justify-content: center;
    align-items: center;
    color: var(--color-text-secondary);
    opacity: 0.8;
    margin-bottom: var(--spacing-xl);
    user-select: none;
    -webkit-user-select: none;
  }

  .swipe-dots {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .swipe-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: currentColor;
    opacity: 0.4;
    transition:
      opacity var(--transition-normal),
      transform var(--transition-normal);
  }

  .swipe-dot.active {
    opacity: 1;
    transform: scale(1.1);
  }

  /* ============================================
     BACK TO TOP
     ============================================ */
  .back-to-top {
    text-align: center;
    margin-block-start: var(--project-content-gap);
    padding-block-end: var(--spacing-xl);
  }

  .back-to-top-link {
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color var(--transition-normal);
    font-family: var(--font-family-body);
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
  }

  .back-to-top-link:hover,
  .back-to-top-link:focus-visible {
    color: var(--color-text-primary);
  }

  .back-to-top-link:focus-visible {
    outline: 2px solid var(--color-primary);
    outline-offset: 4px;
    border-radius: var(--rounded-sm);
  }

  /* ============================================
     RESPONSIVE: DESKTOP (769px - 1511px)
     Maintains 27.12% padding per design system
     ============================================ */
  @media (min-width: 769px) and (max-width: 1511px) {
    .hero-container {
      padding: 0 var(--spacing-container-desktop);
    }
    
    /* project-content-container inherits base 27.12% padding */
    /* No override needed - respects design system */
    
    /* Position arrows within the 27.12% margin area with additional spacing */
    .nav-arrow--prev {
      inset-inline-start: calc(var(--project-container-margin-ratio) + var(--nav-arrow-inset-base) + 20px);
    }
    
    .nav-arrow--next {
      inset-inline-end: calc(var(--project-container-margin-ratio) + var(--nav-arrow-inset-base) + 20px);
    }
    
    .mobile-swipe-hint {
      display: none;
    }
  }

  /* ============================================
     RESPONSIVE: CLIENT VIEWPORT (1512px)
     Exact design specifications
     ============================================ */
  @media (min-width: 1512px) {
    .project-content-container {
      padding-inline: var(--project-container-margin-fixed);
    }
    
    .hero-container {
      padding: 0 var(--spacing-container-desktop);
    }
    
    .nav-arrow--prev {
      /* 410px margin + 20px inset + 20px additional spacing */
      inset-inline-start: calc(var(--project-container-margin-fixed) + var(--nav-arrow-inset-base) + 20px);
    }
    
    .nav-arrow--next {
      inset-inline-end: calc(var(--project-container-margin-fixed) + var(--nav-arrow-inset-base) + 20px);
    }
  }

  /* ============================================
     RESPONSIVE: TABLET PORTRAIT (481px - 768px)
     80% scale factor
     ============================================ */
  @media (min-width: 481px) and (max-width: 768px) {
    .project-content-section {
      padding-block-start: calc(var(--project-hero-to-content) * var(--scale-tablet));
    }
    
    .hero-container,
    .project-content-container {
      padding-inline: var(--spacing-container-mobile);
    }
    
    .image-wrapper:not(:last-child),
    .video-wrapper:not(:last-child),
    .description-with-navigation {
      margin-block-end: calc(var(--project-content-gap) * var(--scale-tablet));
    }
    
    .back-to-top {
      margin-block-start: calc(var(--project-content-gap) * var(--scale-tablet));
    }
    
    .nav-arrow svg {
      width: var(--nav-arrow-size-mobile);
      height: var(--nav-arrow-size-mobile);
    }
  }

  /* ============================================
     RESPONSIVE: MOBILE (max-width: 480px)
     70% scale factor
     ============================================ */
  @media (max-width: 480px) {
    .project-content-section {
      padding-block-start: calc(var(--project-hero-to-content) * var(--scale-mobile));
    }
    
    .hero-container,
    .project-content-container {
      padding-inline: 5vw;
    }
    
    .image-wrapper:not(:last-child),
    .video-wrapper:not(:last-child),
    .description-with-navigation {
      margin-block-end: calc(var(--project-content-gap) * var(--scale-mobile));
    }
    
    .back-to-top {
      margin-block-start: calc(var(--project-content-gap) * var(--scale-mobile));
    }
    
    .project-description {
      padding: 0 var(--spacing-sm);
    }
  }

  /* ============================================
     RESPONSIVE: HIDE/SHOW NAVIGATION
     ============================================ */
  @media (max-width: 1023px) {
    .nav-arrow {
      display: none;
    }
  }

  /* ============================================
     ACCESSIBILITY
     ============================================ */
  @media (prefers-reduced-motion: reduce) {
    .nav-arrow,
    .nav-arrow:hover,
    .swipe-dot,
    .home-link {
      transition: none;
    }
    
    .nav-arrow:hover {
      transform: translateY(-50%);
    }
  }

  @media (prefers-contrast: high) {
    .nav-arrow {
      border: 2px solid ButtonText;
      background: ButtonFace;
      color: ButtonText;
    }
  }
</style>
